name: Update Releases Feed

# Trigger manually or on a schedule
on:
  workflow_dispatch:
  schedule:
    - cron: "15 * * * *"  # every hour at :15

permissions:
  contents: write  # needed to update data/releases.json

jobs:
  update:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        repo:
          - johnmhoran/docusaurus-sandbox-2026-01-15
          - johnmhoran/release-test-01

    steps:
      # 1️⃣ Checkout Repo B
      - name: Checkout Repo B
        uses: actions/checkout@v4

      # 2️⃣ Debug: show which repo we are processing
      - name: Debug - show repo
        run: echo "Fetching latest release for repo: ${{ matrix.repo }}"

      # 3️⃣ Fetch latest release from GitHub API
      - name: Fetch latest release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}  # see below for setup
        run: |
          REPO="${{ matrix.repo }}"
          echo "Fetching latest release for $REPO"
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/repos/$REPO/releases/latest" \
               -o release.json || echo "{}" > release.json

      # 4️⃣ Ensure data folder and releases.json exist
      - name: Ensure data/releases.json
        run: |
          mkdir -p data
          if [ ! -f data/releases.json ]; then
            echo "[]" > data/releases.json
          fi

      # 5️⃣ Update releases.json
      - name: Update releases.json
        run: |
          TMP=$(mktemp)

          REPO="${{ matrix.repo }}"

          jq \
            --arg repo "$REPO" \
            --slurpfile existing data/releases.json \
            '
            $existing[0]
            | map(select(.repo != $repo))
            +
            [
              (input | {
                repo: $repo,
                repo_url: ("https://github.com/" + $repo),
                release_id: .id // 0,
                tag_name: .tag_name // "",
                name: .name // "",
                created_at: .created_at // "",
                published_at: .published_at // "",
                draft: .draft // false,
                prerelease: .prerelease // false,
                target_commitish: .target_commitish // "",
                html_url: .html_url // "",
                tarball_url: .tarball_url // "",
                zipball_url: .zipball_url // ""
              })
            ]
            | sort_by(.published_at) | reverse
            ' release.json > "$TMP"

          mv "$TMP" data/releases.json
          rm release.json

      # 6️⃣ Commit and push if changed
      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/releases.json
          if ! git diff --cached --quiet; then
            git commit -m "Update latest releases"
            git push
          else
            echo "No changes detected"
