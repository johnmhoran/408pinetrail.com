name: Update Releases Feed

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes -- for testing only

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        repo:
          - johnmhoran/docusaurus-sandbox-2026-01-15
          - johnmhoran/release-test-01
          - aboutcode-org/scancode.io
          - aboutcode-org/vulnerablecode

    steps:
      - name: Checkout Repo B
        uses: actions/checkout@v4

      - name: Ensure data directory and file exist
        run: |
          mkdir -p data
          if [ ! -f data/releases.json ]; then
            echo "[]" > data/releases.json
          fi

      - name: Fetch latest release for ${{ matrix.repo }}
        id: fetch
        run: |
          set -e

          API="https://api.github.com/repos/${{ matrix.repo }}/releases/latest"

          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$API")

          # Detect "no releases"
          if echo "$RESPONSE" | jq -e '.message == "Not Found"' > /dev/null; then
            echo "No release found for ${{ matrix.repo }}"
            echo "has_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "$RESPONSE" > release.json
          echo "has_release=true" >> $GITHUB_OUTPUT

      - name: Update releases.json
        if: steps.fetch.outputs.has_release == 'true'
        run: |
          set -e

          TMP=$(mktemp)

          jq \
            --arg repo "${{ matrix.repo }}" \
            --slurpfile existing data/releases.json \
            '
            $existing[0]
            | map(select(.repo != $repo))
            +
            [
              (input | {
                repo: $repo,
                repo_url: ("https://github.com/" + $repo),

                release_id: .id,
                tag_name: .tag_name,
                name: .name,

                created_at: .created_at,
                published_at: .published_at,

                draft: .draft,
                prerelease: .prerelease,
                target_commitish: .target_commitish,

                html_url: .html_url,
                tarball_url: .tarball_url,
                zipball_url: .zipball_url,

                author: (
                  if .author then
                    {
                      login: .author.login,
                      html_url: .author.html_url,
                      type: .author.type
                    }
                  else null
                  end
                ),

                body: (
                  # fallback to empty string if null
                  (.body // "")
                  # remove carriage returns
                  | gsub("\\r"; "")
                  # replace newlines with spaces
                  | gsub("\\n"; " ")
                  # escape any remaining control characters
                  | gsub("[\\x00-\\x1F]"; "")
                  # truncate to 1500 chars max
                  | .[0:1500]
                )

                assets: (
                  if (.assets | length) > 0 then
                    [
                      .assets[] | {
                        name: .name,
                        content_type: .content_type,
                        size: .size,
                        download_count: .download_count,
                        browser_download_url: .browser_download_url
                      }
                    ]
                  else []
                  end
                )
              })
            ]
            | sort_by(.published_at) | reverse
            ' release.json > "$TMP"

          mv "$TMP" data/releases.json
          rm release.json

      - name: Commit changes if any
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add data/releases.json
          git commit -m "Update releases feed"
          git push
